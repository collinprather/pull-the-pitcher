---

title: Pull the pitcher

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Documentation"><a href="https://collinprather.github.io/pull_the_pitcher/">Documentation</a><a class="anchor-link" href="#Documentation"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p>Predicting when MLB managers in the AL will pull their starting pitchers.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Installation">Installation<a class="anchor-link" href="#Installation"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>$ pip install pull-the-pitcher
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-get-the-data">How to get the data<a class="anchor-link" href="#How-to-get-the-data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>ptp</code> library comes with two main command-line utilites. After you install <code>ptp</code>, these should be directly available to you at the command-line, assuming you're in the environment that <code>ptp</code> was installed in.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Storing-data-in-a-sqlite3-db">Storing data in a <code>sqlite3</code> db<a class="anchor-link" href="#Storing-data-in-a-sqlite3-db"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first command-line utility is <a href="/pull_the_pitcher/data_acquisition#query_statcast"><code>query_statcast</code></a>, which invokes <code>pybaseball</code>'s <code>statcast()</code> function to retrieve pitch-level data from statcast. This data will then be stored in a <a href="https://www.sqlite.org/fileformat.html"><code>sqlite3</code> db file</a>. Here's an example of how you could use it.</p>
<div class="highlight"><pre><span></span>$ query_statcast --start_dt <span class="m">2019</span>-05-07 --end_dt <span class="m">2019</span>-06-09 --output_type db --output_path /tmp
This is a large query, it may take a moment to <span class="nb">complete</span>
Completed sub-query from <span class="m">2019</span>-05-07 to <span class="m">2019</span>-05-12
Completed sub-query from <span class="m">2019</span>-05-13 to <span class="m">2019</span>-05-18
Completed sub-query from <span class="m">2019</span>-05-19 to <span class="m">2019</span>-05-24
Completed sub-query from <span class="m">2019</span>-05-25 to <span class="m">2019</span>-05-30
Completed sub-query from <span class="m">2019</span>-05-31 to <span class="m">2019</span>-06-05
Completed sub-query from <span class="m">2019</span>-06-06 to <span class="m">2019</span>-06-09
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Preparing-data-for-modeling">Preparing data for modeling<a class="anchor-link" href="#Preparing-data-for-modeling"> </a></h3><p>The next command-line utility is <a href="/pull_the_pitcher/data_pipeline#prep_data_for_modeling"><code>prep_data_for_modeling</code></a>, which pulls data from the database created in the previous command, then performs feature engineering and various aggregations to yield clean, at-bat level data amenable to a machine learning model. Here's an example of how you might use it.</p>
<div class="highlight"><pre><span></span>$ prep_data_for_modeling --db_path /tmp/statcast_pitches.db --train_test_split_by start --output_path /tmp/
querying db at /tmp/statcast_pitches.db now.
In this dataset, there are <span class="m">457</span> total games.
There are <span class="m">63</span> <span class="s1">&#39;openers&#39;</span> in the dataset.
There are <span class="m">851</span> total eligible game-pitcher combinations in this dataset.
Just processed 0th start.
Just processed 100th start.
Just processed 200th start.
Just processed 300th start.
Just processed 400th start.
Just processed 500th start.
Just processed 600th start.
Just processed 700th start.
Just processed 800th start.
There are <span class="m">91</span> unique pitcher<span class="s1">&#39;s in this dataset</span>
<span class="s1">[&#39;</span><span class="m">2019</span><span class="err">&#39;</span><span class="o">]</span> data ready <span class="k">for</span> modeling and saved at /tmp/.
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="FAQ">FAQ<a class="anchor-link" href="#FAQ"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><p><strong>Should any of the data be considered "uncensored"?</strong></p>
<ul>
<li>The great thing about baseball data is that it is comprehensive, clean, and public! So, <strong>no, none of the data is "censored"</strong> in the survival analysis sense. We know the exact at bat at which every pitcher was removed from the game.</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>If none of the data is uncensored, why are you using survival analysis techniques?</strong></p>
<ul>
<li>Well, the short answer is that they perform the best. Much of survival analysis is dedicated to modeling with <a href="https://square.github.io/pysurvival/intro.html">both censored and uncensored data</a>. Since none of our data is cenored, we have free reign to leverage any predictive modeling technique under the sun. Here, however, the process of predicting when a pitcher will be removed from a game fits very nicely in a time-to-event modeling framework, which survival analysis techniques are designed to handle.</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>How does this approach compare to traditional survival analysis?</strong></p>
<ul>
<li><a href="http://www.sthda.com/english/wiki/cox-proportional-hazards-model">Traditional survival analysis</a> is typically framed as a regression problem, which involves <em>regressing</em> the estimated units of time until the event of interest occurs. Alternatively, the approach we employ is framed as a classification problem, and involves predicting the <em>probability</em> that the event of interest (pitcher removed from the game) occurs at every unit of time (at bat). <ul>
<li>While this neural network, classification-esque approach is non-traditional, it is not unheard of, as seen <a href="https://www.stats.ox.ac.uk/pub/bdr/NNSM.pdf">here</a> and <a href="http://pcwww.liv.ac.uk/~afgt/eleuteri_lyon07.pdf">here</a>.</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>How is this Deep, Recurrent Survival Analysis model different from a traditional LSTM?</strong></p>
<ol>
<li><p>Like other recurrent neural networks, our model predicts the conditional probability that a pitcher was pulled after each at-bat (conditioned on the game that has occurred up to that point). The novelty here occurs in the way that the model "estimates the survival rate through the probability chain rule, which captures the sequential dependency patterns between neighboring at-bats and back-propagates the gradient more efficiently." (quote from page 2 of <a href="https://arxiv.org/pdf/1809.02403.pdf">the original paper</a>).</p>
</li>
<li><p>This notion of estimation of the survival rate through the probability chain rule is further enforced by the use of the <a href="https://collinprather.github.io/drsa/functions/#Event-Time-Loss">event time</a> and the <a href="https://collinprather.github.io/drsa/functions/#Event-Rate-Loss">event rate</a> loss functions. Notice that while our targets are binary, _we are not using traditional <a href="http://wiki.fast.ai/index.php/Log_Loss#Binary_Classification">log loss</a> to train this model_.</p>
</li>
</ol>
</li>
</ul>

</div>
</div>
</div>
</div>
 

